<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Coach Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #f3f4f6; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div x-data="app()" x-init="initApp()" class="flex-grow flex flex-col">

        <div x-show="!isAuthenticated" x-cloak 
             class="fixed inset-0 flex items-center justify-center bg-gray-100 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                <div class="text-4xl mb-4">üîê</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">–î–æ—Å—Ç—É–ø –∫ Run Coach</h2>
                <p class="text-gray-500 mb-6">–í–≤–µ–¥–∏—Ç–µ API Token –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏</p>
                
                <form @submit.prevent="login">
                    <input type="password" x-model="tokenInput" placeholder="–í–∞—à Bearer Token" 
                           class="w-full border bg-gray-50 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition"
                           autofocus>
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition transform active:scale-95">
                        –í–æ–π—Ç–∏
                    </button>
                </form>
            </div>
        </div>

        <div x-show="isAuthenticated" x-cloak class="max-w-5xl mx-auto w-full p-4 md:p-8">
            
            <div class="flex flex-row justify-between items-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2">
                    üèÉ‚Äç‚ôÇÔ∏è Run Coach <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-normal">Admin</span>
                </h1>
                
                <div class="flex gap-2">
                    <button @click="fetchWorkouts()" class="bg-white p-2 rounded-lg shadow-sm hover:bg-gray-50 text-gray-600" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫">
                        üîÑ
                    </button>
                    <button @click="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 text-sm font-medium transition">
                        –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>

            <div class="mb-8">
                <button @click="showAddModal = true" 
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl shadow-lg flex items-center justify-center gap-2 transition transform hover:-translate-y-0.5">
                    <span>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É (JSON)</span>
                </button>
            </div>

            <div x-show="error" x-cloak class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow" role="alert">
                <p x-text="error"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-12">
                <template x-for="workout in workouts" :key="workout.id">
                    <div class="bg-white rounded-2xl shadow-sm hover:shadow-md transition duration-300 overflow-hidden border-l-8 relative group"
                         :class="getBorderColor(workout.meta.workout_type)">
                        
                        <button @click="deleteWorkout(workout.id)" 
                                class="absolute top-4 right-4 p-2 bg-gray-50 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition opacity-100 md:opacity-0 group-hover:opacity-100">
                            üóëÔ∏è
                        </button>

                        <div class="p-6">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-2xl" x-text="getIcon(workout.meta.workout_type)"></span>
                                <span class="text-xs font-bold uppercase tracking-wide text-gray-400" x-text="formatDate(workout.meta.date)"></span>
                            </div>
                            
                            <h3 class="text-xl font-bold text-gray-900 mb-2 leading-tight" x-text="workout.meta.title"></h3>
                            <p class="text-gray-600 text-sm mb-5 line-clamp-2" x-text="workout.meta.description"></p>
                            
                            <div class="flex flex-wrap gap-2 text-xs font-medium">
                                <span class="bg-gray-100 px-2.5 py-1 rounded-md text-gray-600 flex items-center gap-1">
                                    ‚è± <span x-text="Math.round(workout.meta.total_duration_estimate_sec / 60) + ' –º–∏–Ω'"></span>
                                </span>
                                <span class="bg-gray-100 px-2.5 py-1 rounded-md text-gray-600" x-text="workout.meta.workout_type"></span>
                                <span class="bg-gray-100 px-2.5 py-1 rounded-md text-gray-600" 
                                      x-text="pluralize(workout.segments.length, ['—ç—Ç–∞–ø', '—ç—Ç–∞–ø–∞', '—ç—Ç–∞–ø–æ–≤'])"></span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <div x-show="isAuthenticated && workouts.length === 0 && !loading" x-cloak class="text-center text-gray-400 py-12">
                <div class="text-6xl mb-4">üì≠</div>
                <p class="text-xl">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                <p class="text-sm mt-2">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
            </div>
        </div>

        <div x-show="showAddModal" x-cloak 
             class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity"
             @keydown.escape.window="showAddModal = false">
            <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-2xl relative flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                    <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                
                <div class="mb-2">
                    <button @click="insertTemplate()" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                        üìã –í—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä (–®–∞–±–ª–æ–Ω)
                    </button>
                </div>

                <textarea x-model="newJson" 
                          class="w-full flex-grow border rounded-lg p-4 font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                          placeholder='{"id": "...", "meta": {...}}'></textarea>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showAddModal = false" class="px-6 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="submitWorkout()" class="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium transition shadow-md">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_URL = '/workouts'; // ‚ö†Ô∏è –ü—Ä–∏ –¥–µ–ø–ª–æ–µ —É–∫–∞–∂–∏ —Å–≤–æ–π IP/–¥–æ–º–µ–Ω

        function app() {
            return {
                isAuthenticated: false,
                token: '',
                tokenInput: '',
                workouts: [],
                loading: false,
                error: null,
                showAddModal: false,
                newJson: '',

                initApp() {
                    const savedToken = localStorage.getItem('api_token');
                    if (savedToken) {
                        this.token = savedToken;
                        this.isAuthenticated = true;
                        this.fetchWorkouts();
                    }
                },

                login() {
                    if (this.tokenInput.trim() !== '') {
                        this.token = this.tokenInput.trim();
                        localStorage.setItem('api_token', this.token);
                        this.isAuthenticated = true;
                        this.tokenInput = '';
                        this.fetchWorkouts();
                    }
                },

                logout() {
                    if(confirm('–í—ã–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞?')) {
                        localStorage.removeItem('api_token');
                        this.token = '';
                        this.isAuthenticated = false;
                        this.workouts = [];
                    }
                },

                async fetchWorkouts() {
                    this.loading = true;
                    this.error = null;
                    try {
                        const res = await fetch(API_URL, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        
                        if (res.status === 401) {
                            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö –∏–ª–∏ –Ω–µ–≤–µ—Ä–µ–Ω ‚Äî –≤—ã–∫–∏–¥—ã–≤–∞–µ–º –Ω–∞ –ª–æ–≥–∏–Ω
                            this.logout(); 
                            alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω.");
                            return;
                        }
                        
                        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);
                        
                        this.workouts = await res.json();
                        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ –¥–∞—Ç—ã —Å–≤–µ—Ä—Ö—É
                        this.workouts.sort((a, b) => new Date(b.meta.date) - new Date(a.meta.date));
                    } catch (e) {
                        this.error = "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Docker –∏ URL.";
                        console.error(e);
                    } finally {
                        this.loading = false;
                    }
                },

                async submitWorkout() {
                    try {
                        const payload = JSON.parse(this.newJson);
                        const res = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(payload)
                        });

                        if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');

                        this.showAddModal = false;
                        this.newJson = '';
                        this.fetchWorkouts();
                    } catch (e) {
                        alert("–û—à–∏–±–∫–∞!\n" + e.message);
                    }
                },

                async deleteWorkout(id) {
                    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) return;
                    try {
                        const res = await fetch(`${API_URL}/${id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                        this.fetchWorkouts();
                    } catch (e) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å");
                    }
                },

                // === HELPER FUNCTIONS ===

                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ —á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö (1 —ç—Ç–∞–ø, 2 —ç—Ç–∞–ø–∞, 5 —ç—Ç–∞–ø–æ–≤)
                pluralize(n, text_forms) {
                    n = Math.abs(n) % 100; 
                    var n1 = n % 10;
                    if (n > 10 && n < 20) { return n + ' ' + text_forms[2]; }
                    if (n1 > 1 && n1 < 5) { return n + ' ' + text_forms[1]; }
                    if (n1 == 1) { return n + ' ' + text_forms[0]; }
                    return n + ' ' + text_forms[2];
                },

                formatDate(dateStr) {
                    // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
                    return dateStr; 
                },

                getIcon(type) {
                    const icons = {
                        'Recovery': 'üçÉ', 'Easy': 'üèÉ', 'Tempo': 'üî•',
                        'Intervals': '‚ö°', 'LongRun': 'üõ£Ô∏è', 'Test': 'üèÅ'
                    };
                    return icons[type] || 'üìÖ';
                },

                getBorderColor(type) {
                    const colors = {
                        'Recovery': 'border-green-500', 'Easy': 'border-blue-400',
                        'Tempo': 'border-orange-500', 'Intervals': 'border-red-500',
                        'LongRun': 'border-purple-500', 'Test': 'border-black'
                    };
                    return colors[type] || 'border-gray-500';
                },

                insertTemplate() {
                    const today = new Date().toISOString().split('T')[0];
                    const template = {
                        "id": "run_" + today,
                        "meta": {
                            "date": today,
                            "title": "–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞",
                            "workout_type": "Easy",
                            "description": "–õ–µ–≥–∫–∏–π –∫—Ä–æ—Å—Å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ñ–æ—Ä–º—ã",
                            "total_duration_estimate_sec": 3000,
                            "coach_notes": "–°–ª–µ–¥–∏ –∑–∞ –ø—É–ª—å—Å–æ–º",
                            "gear": "–õ—é–±–∏–º—ã–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏",
                            "allow_overtime": false
                        },
                        "segments": [
                            {
                                "segment_type": "simple",
                                "step_type": "warmup",
                                "title": "–†–∞–∑–º–∏–Ω–∫–∞",
                                "duration_sec": 600,
                                "speed_kph": 9.0,
                                "incline_percent": 0.0,
                                "notes": "–ù–∞—á–∏–Ω–∞–µ–º —Å–ø–æ–∫–æ–π–Ω–æ"
                            },
                            {
                                "segment_type": "simple",
                                "step_type": "work",
                                "title": "–ë–µ–≥",
                                "duration_sec": 2400,
                                "speed_kph": 10.5,
                                "incline_percent": 1.0,
                                "notes": "–†–∞–±–æ—á–∏–π —Ç–µ–º–ø"
                            }
                        ]
                    };
                    this.newJson = JSON.stringify(template, null, 2);
                }
            }
        }
    </script>
</body>
</html>